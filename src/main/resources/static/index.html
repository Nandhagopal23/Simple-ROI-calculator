<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Invoicing ROI Simulator</title>
  <style>
    :root{--accent:#0066cc;--muted:#666;--card:#f9f9fb}
    body{font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;max-width:920px;margin:28px auto;padding:20px;color:#222}
    h1{color:var(--accent);margin-bottom:6px}
    p{color:var(--muted);margin-top:0}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px;align-items:start}
    .form{background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(12,24,40,0.06)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;margin-top:12px;color:#333;font-size:14px}
    input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    button{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:#f3f4f6;color:#111;border:1px solid #e6e7ea}
    .panel{background:var(--card);padding:14px;border-radius:8px}
    .result-card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 4px 12px rgba(12,24,40,0.04)}
    .small{font-size:13px;color:var(--muted)}
    .saved-list{max-height:260px;overflow:auto}
    .scenario-item{padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .btn-link{background:transparent;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;padding:0}
    pre#result{white-space:pre-wrap;background:transparent;padding:0;margin:0}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Invoicing ROI Simulator</h1>
  <p>Fill the form and click Calculate. Save scenarios and generate an email-gated HTML report.</p>

  <div class="grid">
    <div class="form">
      <label>Scenario name
        <input id="scenario_name" type="text" placeholder="Q4_Pilot" />
      </label>

  <label>Monthly invoice volume
    <input id="monthly_invoice_volume" type="number" placeholder="" />
  </label>

  <label>Number of AP staff
    <input id="num_ap_staff" type="number" placeholder="" />
  </label>

  <label>Avg hours per invoice (e.g. 0.17 = 10 minutes)
    <input id="avg_hours_per_invoice" type="number" step="0.01" placeholder="e.g. 0.17" />
  </label>

  <label>Hourly wage
    <input id="hourly_wage" type="number" placeholder="e.g. 30" />
  </label>

  <label>Manual error rate (%)
    <input id="error_rate_manual" type="number" step="0.01" placeholder="e.g. 0.5" />
  </label>

  <label>Error cost per incident
    <input id="error_cost" type="number" placeholder="e.g. 100" />
  </label>

  <label>Time horizon (months)
    <input id="time_horizon_months" type="number" placeholder="e.g. 36" />
  </label>

  <label>One-time implementation cost
    <input id="one_time_implementation_cost" type="number" placeholder="e.g. 50000" />
  </label>

      <div style="margin-top:12px" class="controls">
        <button id="calc">Calculate</button>
        <button id="save" class="secondary">Save scenario</button>
        <button id="list" class="secondary">List scenarios</button>
      </div>
    </div>

    <aside>
      <div class="panel">
        <strong>Generate Report</strong>
        <div class="small" style="margin-top:6px">Enter an email to receive or preview the HTML report</div>
        <label style="margin-top:10px">Email for report
          <input id="report_email" type="email" placeholder="you@company.com" />
        </label>
        <div style="margin-top:8px">
          <button id="download_report">Generate & Download Report</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <strong>Saved Scenarios</strong>
        <div class="small">Click Load to populate the form</div>
        <div id="saved_list" class="saved-list" style="margin-top:8px">(none)</div>
      </div>
    </aside>
  </div>

  <h2 style="margin-top:20px">Result</h2>
  <div class="result-card">
    <div id="result">(no result yet)</div>
  </div>

  <template id="scenario-template">
    <div class="scenario-item">
      <div><strong class="s-name"></strong><div class="small s-meta"></div></div>
      <div>
        <button class="btn-link btn-load">Load</button>
        <button class="btn-link btn-delete">Delete</button>
      </div>
    </div>
  </template>

  <script>
    // Load runtime env injected by Netlify build (optional)
    (function(){
      var s = document.createElement('script');
      s.src = '/env.js';
      s.defer = true;
      document.head.appendChild(s);
    })();

    function apiUrl(path) {
      try {
        if (window._env_ && window._env_.API_BASE_URL) {
          return window._env_.API_BASE_URL.replace(/\/$/, '') + path;
        }
      } catch(e) {}
      return path; // relative
    }

    function readInputs() {
      return {
        scenario_name: document.getElementById('scenario_name').value || null,
        monthly_invoice_volume: document.getElementById('monthly_invoice_volume').value,
        num_ap_staff: document.getElementById('num_ap_staff').value,
        avg_hours_per_invoice: document.getElementById('avg_hours_per_invoice').value,
        hourly_wage: document.getElementById('hourly_wage').value,
        error_rate_manual: document.getElementById('error_rate_manual').value,
        error_cost: document.getElementById('error_cost').value,
        time_horizon_months: document.getElementById('time_horizon_months').value,
        one_time_implementation_cost: document.getElementById('one_time_implementation_cost').value
      };
    }

    function validateInputs(values) {
      const required = ['monthly_invoice_volume','num_ap_staff','avg_hours_per_invoice','hourly_wage','time_horizon_months','one_time_implementation_cost'];
      for (const k of required) {
        const v = values[k];
        if (v === null || v === undefined || String(v).trim() === '') {
          return {ok:false, missing:k};
        }
      }
      return {ok:true};
    }

    async function calc() {
      const inputs = readInputs();
      const ok = validateInputs(inputs);
      if (!ok.ok) { alert('Please enter a value for: ' + ok.missing); return; }
      const req = {
        scenario_name: inputs.scenario_name,
        monthly_invoice_volume: parseInt(inputs.monthly_invoice_volume),
        num_ap_staff: parseInt(inputs.num_ap_staff),
        avg_hours_per_invoice: parseFloat(inputs.avg_hours_per_invoice),
        hourly_wage: parseFloat(inputs.hourly_wage),
        error_rate_manual: parseFloat(inputs.error_rate_manual || 0),
        error_cost: parseFloat(inputs.error_cost || 0),
        time_horizon_months: parseInt(inputs.time_horizon_months),
        one_time_implementation_cost: parseFloat(inputs.one_time_implementation_cost)
      };
  const res = await fetch(apiUrl('/simulate'), {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(req)
      });
      if (!res.ok) { alert('Simulation failed: ' + res.status); return; }
      const json = await res.json();
      renderResult(json);
    }
    document.getElementById('calc').addEventListener('click', calc);

    async function saveScenario() {
      const inputs = readInputs();
      const ok = validateInputs(inputs);
      if (!ok.ok) { alert('Please fill the required field: ' + ok.missing); return; }
      const payload = {
        name: document.getElementById('scenario_name').value || ('scenario_' + Date.now()),
        payloadJson: JSON.stringify({
          monthly_invoice_volume: parseInt(inputs.monthly_invoice_volume),
          num_ap_staff: parseInt(inputs.num_ap_staff),
          avg_hours_per_invoice: parseFloat(inputs.avg_hours_per_invoice),
          hourly_wage: parseFloat(inputs.hourly_wage),
          error_rate_manual: parseFloat(inputs.error_rate_manual || 0),
          error_cost: parseFloat(inputs.error_cost || 0),
          time_horizon_months: parseInt(inputs.time_horizon_months),
          one_time_implementation_cost: parseFloat(inputs.one_time_implementation_cost)
        })
      };
  const res = await fetch(apiUrl('/scenarios'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (!res.ok) { alert('Save failed: ' + res.status); return; }
      const json = await res.json();
      alert('Saved: ' + json.id);
    }
    document.getElementById('save').addEventListener('click', saveScenario);

    async function listScenarios() {
      const res = await fetch(apiUrl('/scenarios'));
      if (!res.ok) { alert('Failed to load scenarios'); return; }
      const arr = await res.json();
      renderScenarios(arr);
    }
    document.getElementById('list').addEventListener('click', listScenarios);

    function renderResult(json) {
      const html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><strong>Monthly savings</strong><div class="small">${(json.monthly_savings||0).toFixed(2)}</div></div>
          <div><strong>Payback months</strong><div class="small">${(json.payback_months||0).toFixed(2)}</div></div>
          <div><strong>ROI (%)</strong><div class="small">${(json.roi_percentage||0).toFixed(2)}</div></div>
          <div><strong>Net savings</strong><div class="small">${(json.net_savings||0).toFixed(2)}</div></div>
        </div>
      `;
      document.getElementById('result').innerHTML = html;
    }

    function renderScenarios(arr) {
      const container = document.getElementById('saved_list');
      container.innerHTML = '';
      if (!arr || arr.length === 0) { container.textContent = '(none)'; return; }
      const tpl = document.getElementById('scenario-template');
      arr.forEach(s => {
        const node = tpl.content.cloneNode(true);
        node.querySelector('.s-name').textContent = s.name || ('id:' + s.id);
        const meta = JSON.parse(s.payloadJson || '{}');
        node.querySelector('.s-meta').textContent = `invoices: ${meta.monthly_invoice_volume || '-'}, staff: ${meta.num_ap_staff || '-'}`;
        const el = node.querySelector('.scenario-item');
        el.querySelector('.btn-load').addEventListener('click', () => {
          loadScenario(s);
        });
        el.querySelector('.btn-delete').addEventListener('click', async () => {
          if (!confirm('Delete scenario "' + (s.name||s.id) + '"?')) return;
          const r = await fetch(apiUrl('/scenarios/' + s.id), {method:'DELETE'});
          if (!r.ok) { alert('Delete failed'); return; }
          listScenarios();
        });
        container.appendChild(node);
      });
    }

    function loadScenario(s) {
      const payload = JSON.parse(s.payloadJson || '{}');
      document.getElementById('scenario_name').value = s.name || '';
      document.getElementById('monthly_invoice_volume').value = payload.monthly_invoice_volume || '';
      document.getElementById('num_ap_staff').value = payload.num_ap_staff || '';
      document.getElementById('avg_hours_per_invoice').value = payload.avg_hours_per_invoice || '';
      document.getElementById('hourly_wage').value = payload.hourly_wage || '';
      document.getElementById('error_rate_manual').value = payload.error_rate_manual || '';
      document.getElementById('error_cost').value = payload.error_cost || '';
      document.getElementById('time_horizon_months').value = payload.time_horizon_months || '';
      document.getElementById('one_time_implementation_cost').value = payload.one_time_implementation_cost || '';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    document.getElementById('download_report').addEventListener('click', async () => {
      const email = document.getElementById('report_email').value;
      if (!email) { alert('Please enter an email'); return; }
      const inputs = readInputs();
      const ok = validateInputs(inputs);
      if (!ok.ok) { alert('Please fill the required field: ' + ok.missing); return; }
      const simReq = {
        scenario_name: inputs.scenario_name,
        monthly_invoice_volume: parseInt(inputs.monthly_invoice_volume),
        num_ap_staff: parseInt(inputs.num_ap_staff),
        avg_hours_per_invoice: parseFloat(inputs.avg_hours_per_invoice),
        hourly_wage: parseFloat(inputs.hourly_wage),
        error_rate_manual: parseFloat(inputs.error_rate_manual || 0),
        error_cost: parseFloat(inputs.error_cost || 0),
        time_horizon_months: parseInt(inputs.time_horizon_months),
        one_time_implementation_cost: parseFloat(inputs.one_time_implementation_cost)
      };
      const payload = { email: email, scenario_name: inputs.scenario_name || 'scenario', simulationRequest: simReq };
  const res = await fetch(apiUrl('/report/generate'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (!res.ok) { alert('Report generation failed: ' + res.status); return; }
      const html = await res.text();
      // open report in new window as HTML
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
    });
  </script>
</body>
</html>
